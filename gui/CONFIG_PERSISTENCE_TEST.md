# 配置持久化功能测试指南

## 功能说明

现在设置面板的配置会在关闭面板后保持，只有关闭主窗口才会重置为默认值。

## 实现原理

1. **共享配置字典**：主窗口维护一个 `app_config` 字典，包含所有应用配置
2. **引用传递**：设置面板接收 `app_config` 的引用（而不是副本）
3. **双向绑定**：
   - 打开设置面板时，从 `app_config` 读取初始值
   - 保存配置时，更新 `app_config` 中的值
4. **生命周期**：配置在主窗口的整个生命周期内保持，直到程序退出

## 测试步骤

### 测试1：RTSP配置持久化

1. **打开设置面板**
   - 点击主窗口的"⚙️ 设置"按钮
   - 观察RTSP页面的默认值（应该是 `rtsp://`，用户名、密码为空，端口554，超时10秒）

2. **修改RTSP配置**
   - 修改RTSP URL为：`rtsp://192.168.1.100/stream`
   - 输入用户名：`admin`
   - 输入密码：`password123`
   - 修改端口为：`8554`
   - 修改超时为：`30`秒
   - 点击"保存配置"按钮

3. **关闭设置面板**
   - 点击设置面板右上角的关闭按钮 ✕

4. **重新打开设置面板**
   - 再次点击主窗口的"⚙️ 设置"按钮
   - 切换到"📡 RTSP流配置"页面
   - **验证**：所有字段应该保持上次修改的值
     - URL: `rtsp://192.168.1.100/stream`
     - 用户名: `admin`
     - 密码: `password123` (显示为 *****)
     - 端口: `8554`
     - 超时: `30`

### 测试2：场景配置持久化

1. **打开设置面板**
   - 点击主窗口的"⚙️ 设置"按钮
   - 切换到"🎬 场景配置"页面
   - 观察默认值（场景类型：摔倒，光照：正常，ROI：关闭，声音报警：开启，邮件通知：关闭，自动录像：开启）

2. **修改场景配置**
   - 场景类型保持"摔倒"
   - 光照条件改为："昏暗"
   - 勾选"启用感兴趣区域(ROI)"
   - 取消勾选"声音报警"
   - 勾选"邮件通知"
   - 取消勾选"自动录像"
   - 点击"保存配置"按钮

3. **关闭并重新打开设置面板**
   - 关闭设置面板
   - 重新打开设置面板
   - 切换到"🎬 场景配置"页面
   - **验证**：所有设置应该保持修改后的值
     - 光照条件：昏暗（选中）
     - ROI：已勾选
     - 声音报警：未勾选
     - 邮件通知：已勾选
     - 自动录像：未勾选

### 测试3：多次修改持久化

1. **第一次修改**
   - 打开设置面板
   - RTSP URL改为：`rtsp://test1.com/stream`
   - 保存并关闭

2. **第二次修改**
   - 打开设置面板
   - **验证**：URL应该是 `rtsp://test1.com/stream`
   - 将URL改为：`rtsp://test2.com/stream`
   - 保存并关闭

3. **第三次验证**
   - 打开设置面板
   - **验证**：URL应该是最新的 `rtsp://test2.com/stream`

### 测试4：配置重置（关闭主窗口）

1. **修改配置**
   - 打开设置面板
   - 修改RTSP URL为：`rtsp://temporary.com/stream`
   - 修改场景光照为"明亮"
   - 保存并关闭设置面板

2. **关闭主窗口**
   - 点击主窗口右上角的关闭按钮 ✕
   - 程序退出

3. **重新启动程序**
   - 运行 `/usr/local/bin/python3 gui/main_window.py`
   - 打开设置面板
   - **验证**：所有配置应该恢复为默认值
     - RTSP URL: `rtsp://`
     - 用户名、密码：空
     - 端口：554
     - 超时：10
     - 场景类型：摔倒
     - 光照条件：正常
     - ROI：关闭
     - 声音报警：开启
     - 邮件通知：关闭
     - 自动录像：开启

## 配置结构

程序中的配置字典结构如下：

```python
app_config = {
    "rtsp": {
        "url": "rtsp://",
        "username": "",
        "password": "",
        "port": "554",
        "timeout": "10"
    },
    "scene": {
        "scene_type": "摔倒",
        "light_condition": "normal",
        "enable_roi": False,
        "enable_sound": True,
        "enable_email": False,
        "auto_record": True
    },
    "scene_types": ["摔倒", "起火"]
}
```

## 调试信息

在终端中可以看到保存配置时的调试输出：

- **保存RTSP配置时**：
  ```
  RTSP配置已保存到app_config: {'url': '...', 'username': '...', ...}
  ```

- **保存场景配置时**：
  ```
  场景配置已保存到app_config: {'scene_type': '...', 'light_condition': '...', ...}
  ```

## 预期行为

✅ **正确行为**：
- 在同一程序会话中，设置面板的配置会持久化
- 可以多次打开/关闭设置面板，配置保持不变
- 每次保存都更新主窗口的 `app_config` 字典

❌ **不会发生**：
- 关闭设置面板不会重置配置
- 打开设置面板不会丢失上次的修改
- 配置不会在程序运行期间意外重置

⚠️ **注意**：
- 配置目前仅在内存中，不会保存到文件
- 关闭主窗口后重新启动，配置会恢复默认值
- 如需跨会话持久化，可以后续添加配置文件保存/加载功能

## 故障排除

如果配置没有持久化：

1. **检查是否点击了"保存配置"按钮**
   - 修改配置后必须点击保存按钮

2. **检查终端输出**
   - 应该能看到"RTSP配置已保存到app_config"或"场景配置已保存到app_config"

3. **确认是同一个程序实例**
   - 不要关闭主窗口，只关闭设置面板

4. **查看调试信息**
   - 终端输出会显示配置字典的内容
   - 可以验证配置是否正确更新
